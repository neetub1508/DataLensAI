# Backend Test Dockerfile - Volume-friendly
FROM eclipse-temurin:17-jdk-jammy

# Create app user to avoid permission issues
RUN groupadd -r appuser && useradd -r -g appuser appuser

# Set working directory
WORKDIR /app

# Install necessary tools and download Maven manually to avoid Java version conflicts
RUN apt-get update && apt-get install -y \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Download and install Maven manually to preserve Java 17
RUN curl -fsSL https://archive.apache.org/dist/maven/maven-3/3.9.5/binaries/apache-maven-3.9.5-bin.tar.gz | tar xzf - -C /opt \
    && ln -s /opt/apache-maven-3.9.5 /opt/maven \
    && ln -s /opt/maven/bin/mvn /usr/local/bin/mvn

# Set environment variables for Java and Maven
ENV JAVA_HOME=/opt/java/openjdk
ENV MAVEN_HOME=/opt/maven
ENV PATH=$JAVA_HOME/bin:$MAVEN_HOME/bin:$PATH

# Copy project files for dependency resolution
COPY pom.xml ./

# Create directories and set permissions
RUN mkdir -p src/main/java src/test/java target .m2 /home/appuser/.m2/repository && \
    chown -R appuser:appuser /app /home/appuser

# Pre-download common test dependencies to cache layer
RUN mvn dependency:resolve dependency:resolve-sources -B -DskipTests 2>/dev/null || \
    echo "Some dependencies failed to resolve - continuing with available ones"

# Copy actual source code
COPY src ./src/

# Create entrypoint script to fix permissions
RUN echo '#!/bin/bash\n\
# Ensure Maven directory has proper permissions\n\
mkdir -p /home/appuser/.m2/repository\n\
chown -R appuser:appuser /home/appuser/.m2\n\
# Switch to appuser\n\
exec sudo -u appuser "$@"' > /entrypoint.sh && \
    chmod +x /entrypoint.sh

# Ensure proper permissions
RUN chown -R appuser:appuser /app

# Install sudo for the entrypoint
RUN apt-get update && apt-get install -y sudo && \
    echo 'appuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers && \
    rm -rf /var/lib/apt/lists/*

ENTRYPOINT ["/entrypoint.sh"]

# Set default command for testing
CMD ["mvn", "test", "-Djacoco.skip=true", "-DfailIfNoTests=false"]